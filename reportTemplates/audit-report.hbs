<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{{reportDetails.title}}</title>
  <style>
    * { font-family: 'Calibri', 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
    html, body { background: white; }
    body { max-width: 210mm; margin: 0 auto; padding: 0; color: #1e293b; font-size: 11pt; line-height: 1.5; }

    .page { page-break-after: always; width: 100%; padding: 15mm 17mm; min-height: 297mm; position: relative; }
    .page:last-child { page-break-after: auto; }

    h1 { font-size: 26px; color: #365F91; text-transform: uppercase; text-align: center; margin-bottom: 8px; }
    h2 { font-size: 20px; color: #365F91; text-transform: uppercase; text-align: center; margin-bottom: 6px; }
    h3 { font-size: 16px; color: #365F91; text-transform: uppercase; margin: 20px 0 10px 0; border-bottom: 2px solid #365F91; padding-bottom: 4px; }
    h4 { font-size: 13px; color: #365F91; text-transform: uppercase; margin: 14px 0 6px 0; }
    p { margin: 4px 0; font-size: 11pt; }

    .cover { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .cover-meta { margin-top: 40px; font-size: 12px; color: #64748b; }
    .cover-meta table { margin: 0 auto; border-collapse: collapse; }
    .cover-meta td { padding: 4px 12px; text-align: left; }
    .cover-meta td:first-child { font-weight: 600; color: #334155; }

    table { width: 100%; border-collapse: collapse; margin: 8px 0 14px 0; font-size: 10pt; }
    th { background-color: #365F91; color: #fff; font-weight: 600; text-align: left; padding: 6px 8px; border: 1px solid #365F91; font-size: 10pt; }
    td { padding: 5px 8px; border: 1px solid #cbd5e1; vertical-align: top; word-wrap: break-word; }
    tr:nth-child(even) td { background-color: #f8fafc; }
    .label-cell { background-color: #e8edf4; font-weight: 600; color: #334155; width: 35%; }

    .stats-row { display: flex; gap: 12px; margin: 14px 0; flex-wrap: wrap; }
    .stat-card { flex: 1; min-width: 140px; border: 1px solid #cbd5e1; border-radius: 6px; padding: 12px; text-align: center; }
    .stat-value { font-size: 28px; font-weight: 700; color: #365F91; }
    .stat-label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

    .badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 9px; font-weight: 600; }
    .badge-blue { background: #dbeafe; color: #1e40af; }
    .badge-green { background: #dcfce7; color: #166534; }
    .badge-amber { background: #fef3c7; color: #92400e; }
    .badge-gray { background: #f1f5f9; color: #475569; }

    .group-header { background: #f1f5f9; padding: 8px 10px; margin: 14px 0 6px 0; border-left: 3px solid #365F91; font-weight: 600; font-size: 12px; color: #334155; }

    .empty-state { color: #94a3b8; font-style: italic; padding: 10px; text-align: center; }
    .footer-line { margin-top: 30px; border-top: 1px solid #cbd5e1; padding-top: 8px; font-size: 9px; color: #94a3b8; text-align: center; }
    .truncated-notice { background: #fef3c7; border: 1px solid #fde68a; padding: 8px 12px; border-radius: 4px; font-size: 10px; color: #92400e; margin: 10px 0; }
    .ts { font-size: 9px; color: #94a3b8; white-space: nowrap; }

    @media print {
      .page { page-break-after: always; padding: 10mm 15mm; }
      body { max-width: none; }
    }
  </style>
</head>
<body>

  <!-- COVER PAGE -->
  <div class="page cover">
    <div style="margin-top: 80px;">
      {{#if organisation.name}}
        <h2 style="font-size: 16px; color: #64748b; text-transform: none;">{{organisation.name}}</h2>
      {{/if}}
    </div>
    <h1 style="margin-top: 20px;">{{reportDetails.title}}</h1>
    <p style="font-size: 14px; color: #475569; margin-top: 8px;">
      {{reportDetails.period.start}} &mdash; {{reportDetails.period.end}}
    </p>
    <div class="cover-meta">
      <table>
        {{#if reportDetails.preparedBy}}<tr><td>Prepared By:</td><td>{{reportDetails.preparedBy}}</td></tr>{{/if}}
        <tr><td>Report Date:</td><td>{{reportDetails.reportDate}}</td></tr>
        <tr><td>Detail Level:</td><td>{{scope.detailLevel}}</td></tr>
        <tr><td>Grouping:</td><td>{{scope.grouping}}</td></tr>
        <tr><td>Format:</td><td>{{reportDetails.exportFormat}}</td></tr>
      </table>
    </div>
    <div class="footer-line">Audit Trail Report &mdash; Generated {{generatedAt}}</div>
  </div>

  <!-- SUMMARY & SCOPE -->
  <div class="page">
    <h3>Audit Summary</h3>

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-value">{{summary.totalEvents}}</div>
        <div class="stat-label">Total Events</div>
      </div>
    </div>

    {{#if summary.maxResultsApplied}}
    <div class="truncated-notice">
      Results have been limited to the maximum threshold. Narrow the date range or apply additional filters for complete data.
    </div>
    {{/if}}

    <h3>Scope &amp; Filters</h3>
    <table>
      <tr><td class="label-cell">Period</td><td>{{reportDetails.period.start}} to {{reportDetails.period.end}}</td></tr>
      <tr><td class="label-cell">Detail Level</td><td>{{scope.detailLevel}}</td></tr>
      <tr><td class="label-cell">Grouping</td><td>{{scope.grouping}}</td></tr>
      <tr>
        <td class="label-cell">Event Types</td>
        <td>
          {{#each scope.eventTypes}}
            <span class="badge badge-blue">{{this}}</span>
          {{/each}}
          {{#unless scope.eventTypes.length}}<span class="badge badge-gray">All</span>{{/unless}}
        </td>
      </tr>
      {{#if scope.filters.vessel}}<tr><td class="label-cell">Vessel Filter</td><td>{{scope.filters.vessel}}</td></tr>{{/if}}
      {{#if scope.filters.workOrder}}<tr><td class="label-cell">Work Order Filter</td><td>{{scope.filters.workOrder}}</td></tr>{{/if}}
      {{#if scope.filters.user}}<tr><td class="label-cell">User Filter</td><td>{{scope.filters.user}}</td></tr>{{/if}}
    </table>
  </div>

  <!-- AUDIT ENTRIES -->
  <div class="page">
    <h3>Audit Trail</h3>

    {{#if isGrouped}}
      {{!-- Grouped entries: entries is an object keyed by group --}}
      {{#each entries}}
        <div class="group-header">{{@key}} ({{this.length}} events)</div>
        <table>
          <thead>
            <tr>
              <th style="width: 15%">Timestamp</th>
              <th style="width: 15%">Entity</th>
              <th style="width: 12%">Action</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            {{#each this}}
            <tr>
              <td class="ts">{{timestamp}}</td>
              <td>{{entityType}}{{#if entityId}} <span class="badge badge-gray">{{truncateId entityId}}</span>{{/if}}</td>
              <td><span class="badge badge-amber">{{action}}</span></td>
              <td>{{description}}</td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      {{/each}}
    {{else}}
      {{!-- Chronological: entries is an array --}}
      {{#if entries.length}}
      <table>
        <thead>
          <tr>
            <th style="width: 15%">Timestamp</th>
            <th style="width: 15%">Entity</th>
            <th style="width: 12%">Action</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {{#each entries}}
          <tr>
            <td class="ts">{{timestamp}}</td>
            <td>{{entityType}}{{#if entityId}} <span class="badge badge-gray">{{truncateId entityId}}</span>{{/if}}</td>
            <td><span class="badge badge-amber">{{action}}</span></td>
            <td>{{description}}</td>
          </tr>
          {{/each}}
        </tbody>
      </table>
      {{else}}
      <p class="empty-state">No audit events found for the selected criteria.</p>
      {{/if}}
    {{/if}}

    {{#if additionalNotes}}
    <h3>Additional Notes</h3>
    <p>{{additionalNotes}}</p>
    {{/if}}

    <div class="footer-line">
      {{#if organisation.name}}{{organisation.name}} &mdash; {{/if}}{{reportDetails.title}} &mdash; {{reportDetails.reportDate}}
    </div>
  </div>

</body>
</html>
